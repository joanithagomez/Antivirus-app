<?php
session_start();

if (!$_SESSION['username']) {
    header("Location: login.php");//redirect to login page to secure the welcome page without login access.
}
$forename = $_SESSION['name'];

echo <<<_END
<html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<title>Admin Home</title></head>
<body>
<div class="container">
<div class="row">
    <div class="col-sm-12">
    <h2>Welcome back $forename!</h2>
    </div>
  </div>

<form method="post" action="malwareupload.php" role="form" enctype="multipart/form-data">
<div class="form-group">
   <label for="malwarename">Name of malware</label>
   <input type="text" name="malwarename" class="form-control" id="malwarename" aria-describedby="malwarename">
   <small id="malwarename" class="form-text text-muted">What's the malware you uploaded?</small>
 </div>
 <div class="form-group">
    <label for="filename">Malware Upload</label>
    <input type="file" name="filename" class="form-control"  id="filename" aria-describedby="filename">
    <small id="malwarename" class="form-text text-muted">What's the malware you uploaded?</small>
  </div>
  <div class="form-group">
  <input type="submit" name="submit" class="btn btn-primary" value="Submit">
  </div>
</form>
_END;

include_once 'db.php';

if (isset($_POST["submit"])) {
    $malwarename = $_POST['malwarename'];

    if ($_FILES) { //check if user uploaded a file

        $name = strtolower(preg_replace("[^A-Za-z0-9.]", "", $_FILES['filename']['name']));  //sanitizing name of the file to work in any OS

        if ($_FILES['filename']['type'] === "text/plain") { //checking if the right type of data(.txt) is received

            move_uploaded_file($_FILES['filename']['tmp_name'], $name);  //moving file from the temporary location to permanent one

            echo "$malwarename upload successful!<br>";

            $arrOfwords = saveSignature($conn, $name, $malwarename); //parse file and get the words in file as an array

            if ($arrOfwords) { //if array is not empty, find numbers in the array
                printResult($arrOfwords);
            }
        } else {
            echo "'$name' is not an accepted text file<br>";
        }
    } else {
        echo "Please upload malware file<br>";
    }
}


  function saveSignature($conn, $file, $malwarename)
  {
      if (!function_exists('file_get_contents') || !function_exists('preg_replace')) {  //making sure build-in functions exist
          echo "Some functions not found. Could not get contents.";
          return;
      }

      $contents = file_get_contents($file);

      $query = "INSERT INTO malwares (name,contents) VALUES ('$malwarename', '$contents')";
      $result = $conn->query($query);
      if (!$result) {
          die($conn->error);
      }


      if (empty($contents)) { // if the file is empty display message
          echo "File is empty.";
          return;
      }

      // $text = preg_replace("/(?![.=$'â‚¬%-])\p{P}/u", " ", $contents);//reading entire file using file_get_contents and replacing all punctuations with white space
      // $words = explode(" ", $text);  //splitting each word with space delimiter
      //
      // return $words;
  }


    function printResult($arrOfwords)
    {
        foreach ($arrOfwords as $word) {  //iterating through each word and printing it if it's a number
          if (is_numeric($word)) { //using built-in function to find if the word is numeric
            echo "<h3>$word<h3/>";
          }
        }
    }
  echo "<a href='logout.php'>Logout here</a></div></body></html>";
