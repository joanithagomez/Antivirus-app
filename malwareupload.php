<?php
include_once 'db.php';

session_start();

if (!$_SESSION['username']) {
    header("Location: login.php");
}
if ($_SESSION['check'] != hash('ripemd128', $_SERVER['REMOTE_ADDR'] .$_SERVER['HTTP_USER_AGENT'])) {
    different_user();
}

 $malwarename = "";

if (isset($_POST['malwarename'])) {
    $malwarename = fix_string($_POST['malwarename']);
}

$fail = validate_malwarename($malwarename);

echo <<<_END
<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<title>Admin Home</title>
_END;

if ($fail == "") {
    submitFile($conn, $malwarename);
}

$forename = $_SESSION['name'];

echo <<<_END
<script>
function validate(form){
  fail = validateMalwareName(form.malwarename.value)
  fail += validateFile(form.filename.value)

  if (fail == "") {
    return true
  }
  else {
    document.getElementById("error").innerHTML = fail;
    return false
  }
}

function validateMalwareName(field) {
  if(field == ""  || field.trim() == "") return "Malware name cannot be empty. <br>"
  else if (/[^a-zA-Z0-9]/.test(field)) return "Only alphabets and numbers allowed for malware name.<br>"
  else return ""
}

function validateFile(field){
  if(document.getElementById("filename").value == "") {
    return "No file chosen. <br>";
}else
  return "";
}
</script>
</head>
<body>
<div class="container">
<div class="row">
    <div class="col-sm-12">
    <h2>Welcome back $forename!</h2>
    </div>
  </div>
<form method="post" action="malwareupload.php" role="form" onsubmit="return validate(this)">
<div class="form-group">
   <label for="malwarename">Name of malware</label>
   <input type="text" name="malwarename" class="form-control" id="malwarename" aria-describedby="malwarename">
 </div>
 <div class="form-group">
    <label for="filename">Malware Upload</label>
    <input type="file" name="filename" class="form-control"  id="filename" aria-describedby="filename">
  </div>
  <div class="form-group">
  <input type="submit" name="submit" class="btn btn-primary" value="Submit">
  </div>
</form>
<div id="error"></div>
_END;

    function submitFile($conn, $malwarename)
    {
        if (isset($_POST["submit"])) {
            if ($_FILES) { //check if user uploaded a file

                $name = strtolower(preg_replace("[^A-Za-z0-9.]", "", $_FILES['filename']['name']));  //sanitizing name of the file to work in any OS

                move_uploaded_file($_FILES['filename']['tmp_name'], $name);  //moving file from the temporary location to permanent one

                echo "$malwarename upload successful!<br>";

                saveSignature($conn, $name, $malwarename); //parse file and get the words in file as an array
            } else {
                echo "Please upload malware file<br>";
            }
        }
    }


  function saveSignature($conn, $file, $malwarename)
  {
      if (!function_exists('file_get_contents') || !function_exists('preg_replace')) {  //making sure build-in functions exist
          echo "Some functions not found. Could not get contents.";
          return;
      }

      $contents = file_get_contents($file);

      $query = "INSERT INTO malwares (name,contents) VALUES ('$malwarename', '$contents')";
      $result = $conn->query($query);
      if (!$result) {
          die($conn->error);
      }

      if (empty($contents)) { // if the file is empty
          echo "File is empty.";
          return;
      }
  }


    function different_user()
    {
        $_SESSION = array();
        setcookie(session_name(), '', time() - 2592000, '/');
        session_destroy();

        session_start();
        $_SESSION['message'] = 'Technical Error.';
        header("Location: login.php");
    }

    function fix_string($string)
    {
        if (get_magic_quotes_gpc()) {
            $string = stripslashes($string);
        }
        return htmlentities($string);
    }


      function validate_malwarename($field)
      {
          if ($field == "" || trim($field) == "") {
              return "Malware name cannot be empty. <br>";
          } elseif (preg_match("/[^a-zA-Z0-9]/", $field)) {
              return "Only letters and numbers in malware name<br>";
          } else {
              return "";
          }
      }

  echo "<a href='logout.php'>Logout here</a></div></body></html>";
