<?php
include_once 'db.php';

session_start();

if (!$_SESSION['username']) {
    header("Location: login.php");
}
if ($_SESSION['check'] != hash('ripemd128', $_SERVER['REMOTE_ADDR'] .$_SERVER['HTTP_USER_AGENT'])) {
    different_user();
}

 $malwarename = "";

if (isset($_POST['malwarename'])) {
    $malwarename = fix_string($_POST['malwarename']);
}

$fail = validate_malwarename($malwarename);

echo <<<_END
<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<title>Admin Home</title>
_END;

if ($fail == "") {
    submitFile($conn, $malwarename);
}

$forename = $_SESSION['name'];

echo <<<_END
<script>
function validate(form){
  fail = validateMalwareName(form.malwarename.value)
  fail += validateFile(form.filename.value)

  if (fail == "") {
    return true
  }
  else {
    document.getElementById("error").innerHTML = fail;
    return false
  }
}

function validateMalwareName(field) {
  if(field == ""  || field.trim() == "") return "Malware name cannot be empty. <br>"
  else if (/[^a-zA-Z0-9]/.test(field)) return "Only alphabets and numbers allowed for malware name.<br>"
  else return ""
}

function validateFile(field){
  if(document.getElementById("filename").value == "") {
    return "No file chosen. <br>";
}else
  return "";
}
</script>
</head>
<body>
<div class="container">
<div class="row">
    <div class="col-sm-12">
    <h2>Welcome back $forename!</h2>
    </div>
  </div>
<form method="post" action="malwareupload.php" role="form" onsubmit="return validate(this)" enctype="multipart/form-data">
<div class="form-group">
   <label for="malwarename">Name of malware</label>
   <input type="text" name="malwarename" class="form-control" id="malwarename" aria-describedby="malwarename">
 </div>
 <div class="form-group">
    <label for="filename">Malware Upload</label>
    <input type="file" name="filename" class="form-control"  id="filename" aria-describedby="filename">
  </div>
  <div class="form-group">
  <input type="submit" name="submit" class="btn btn-primary" value="Submit">
  </div>
</form>
<div id="error"></div>
_END;

    function submitFile($conn, $malwarename)
    {
        if ($_FILES) {
            $name = strtolower(preg_replace("[^A-Za-z0-9.]", "", $_FILES['filename']['name']));  //sanitizing name of the file to work in any OS
          if (move_uploaded_file($_FILES['filename']['tmp_name'], $name)) {  //moving file from the temporary location to permanent one
                echo "$malwarename upload successful!<br>";
              saveSignature($conn, $name, $malwarename);
          }
        } else {
            echo 'You should select a file to upload !!';
        }
    }


  function saveSignature($conn, $file, $malwarename)
  {
      $contents = getContents($file);
      if (empty($contents)) { // if the file is empty
          return;
      }
      $query = "INSERT INTO malwares (name,contents) VALUES ('$malwarename', '$contents');";
      $result = $conn->query($query);
      if (!$result) {
          die($conn->error);
      }
      $conn->close();
  }

  function getContents($file)
  {
      $signature = "";
      $handle = fopen($file, "rb");
      $fsize = 20;
      $data = fread($handle, $fsize);
      $byteArray = unpack("N*", $data);
      if (sizeof($byteArray)<= 0) {
          $signature = "";
      } elseif (sizeof($byteArray) < 2) {
          $sig = $byteArray [1];
      } else {
          $signature = $byteArray [1];
          $signature .= $byteArray [2];
      }
      fclose($handle);
      return $signature;
  }


    function different_user()
    {
        $_SESSION = array();
        setcookie(session_name(), '', time() - 2592000, '/');
        session_destroy();

        session_start();
        $_SESSION['message'] = 'Technical Error.';
        header("Location: login.php");
    }

    function fix_string($string)
    {
        if (get_magic_quotes_gpc()) {
            $string = stripslashes($string);
        }
        return htmlentities($string);
    }


      function validate_malwarename($field)
      {
          if ($field == "" || trim($field) == "") {
              return "Malware name cannot be empty. <br>";
          } elseif (preg_match("/[^a-zA-Z0-9]/", $field)) {
              return "Only letters and numbers in malware name<br>";
          } else {
              return "";
          }
      }

  echo "<a href='logout.php'>Logout here</a></div></body></html>";
